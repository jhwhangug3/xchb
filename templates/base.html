<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}meowCHAT{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="A modern social media and messaging platform">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="meowCHAT">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/fav.png') }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='images/fav.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/fav.png') }}">
    <link rel="apple-touch-icon" sizes="167x167" href="{{ url_for('static', filename='images/fav.png') }}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/fav.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/fav.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/fav.png') }}">
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    
    <!-- PWA Utilities -->
    <script src="{{ url_for('static', filename='js/pwa-utils.js') }}" defer></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar-meow" id="topNav">
        <div class="inner">
            <a class="brand" href="{{ url_for('dashboard') }}">
                <img src="{{ url_for('static', filename='images/nav.png') }}" alt="meowCHAT"/>
            </a>
            <div class="actions position-relative">
                <!-- Remove profile button from top nav since it's now in bottom nav -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content-wrapper">
        {% block content %}{% endblock %}
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav" id="bottomNav">
        <div class="bottom-nav-inner">
            <a href="{{ url_for('dashboard') }}" class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                <i class="fas fa-home"></i>
            </a>
            <a href="{{ url_for('messaging') }}" class="nav-item {% if request.endpoint == 'messaging' %}active{% endif %}">
                <i class="fas fa-comment"></i>
            </a>
            <a href="{{ url_for('create_post') }}" class="nav-item {% if request.endpoint == 'create_post' %}active{% endif %}">
                <i class="fas fa-plus"></i>
            </a>
            <a href="{{ url_for('notifications') }}" class="nav-item {% if request.endpoint == 'notifications' %}active{% endif %}">
                <i class="fas fa-bell"></i>
            </a>
            <a href="{{ get_profile_url(user) }}" class="nav-item {% if request.endpoint in ['profile', 'view_user_profile_by_username', 'view_user_profile_by_username_alt', 'view_user_profile'] %}active{% endif %}">
                <div class="profile-avatar-small">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture }}" alt="Profile"/>
                    {% else %}
                        <i class="fas fa-user"></i>
                    {% endif %}
                </div>
            </a>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            const root = document.documentElement;
            root.setAttribute('data-theme', 'dark');
        })();
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration);
                        
                        // Handle service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    showUpdateNotification();
                                }
                            });
                        });

                        // Check for updates immediately
                        registration.update();
                        
                        // Request notification permission if not already granted
                        if ('Notification' in window && Notification.permission === 'default') {
                            // Show a subtle notification permission request
                            setTimeout(() => {
                                showNotificationPermissionRequest();
                            }, 3000); // Wait 3 seconds after page load
                        }
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Show notification permission request
        function showNotificationPermissionRequest() {
            // Don't show if user has already made a decision
            if (Notification.permission !== 'default') {
                return;
            }
            
            // Don't show if already shown recently
            if (localStorage.getItem('notificationPromptShown')) {
                return;
            }
            
            // Mark as shown
            localStorage.setItem('notificationPromptShown', 'true');
            
            const prompt = document.createElement('div');
            prompt.className = 'notification-permission-prompt';
            prompt.innerHTML = `
                <div class="notification-permission-content">
                    <div class="notification-permission-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="notification-permission-text">
                        <h4>Stay Updated</h4>
                        <p>Get notified when someone messages you or likes your posts</p>
                    </div>
                    <div class="notification-permission-actions">
                        <button class="btn btn-primary btn-sm" onclick="requestNotificationPermission()">
                            <i class="fas fa-check"></i>
                            Enable Notifications
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="dismissNotificationPrompt()">
                            Not Now
                        </button>
                    </div>
                    <button class="notification-permission-close" onclick="dismissNotificationPrompt()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(prompt);
            
            // Auto-dismiss after 15 seconds
            setTimeout(() => {
                dismissNotificationPrompt();
            }, 15000);
        }
        
        // Request notification permission
        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    // Subscribe to push notifications
                    if (window.pwaUtils) {
                        await window.pwaUtils.subscribeToNotifications();
                    }
                    
                    // Show success message
                    showNotificationSuccess();
                }
                
                dismissNotificationPrompt();
            } catch (error) {
                console.error('Error requesting notification permission:', error);
                dismissNotificationPrompt();
            }
        }
        
        // Show notification success message
        function showNotificationSuccess() {
            const success = document.createElement('div');
            success.className = 'notification-success';
            success.innerHTML = `
                <div class="notification-success-content">
                    <i class="fas fa-check-circle"></i>
                    <span>Notifications enabled!</span>
                </div>
            `;
            
            document.body.appendChild(success);
            
            // Remove after 3 seconds
            setTimeout(() => {
                success.remove();
            }, 3000);
        }
        
        // Dismiss notification prompt
        function dismissNotificationPrompt() {
            const prompt = document.querySelector('.notification-permission-prompt');
            if (prompt) {
                prompt.remove();
            }
        }

        // Show update notification
        function showUpdateNotification() {
            if (confirm('A new version of meowCHAT is available! Would you like to update?')) {
                // Reload the page to activate the new service worker
                window.location.reload();
            }
        }

        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            // Create install button if it doesn't exist
            if (!document.getElementById('installButton')) {
                const installBtn = document.createElement('div');
                installBtn.id = 'installButton';
                installBtn.className = 'install-prompt';
                installBtn.innerHTML = `
                    <div class="install-prompt-content">
                        <i class="fas fa-download"></i>
                        <span>Install meowCHAT</span>
                        <button onclick="installApp()" class="btn btn-primary btn-sm">Install</button>
                        <button onclick="dismissInstall()" class="btn btn-secondary btn-sm">Later</button>
                    </div>
                `;
                document.body.appendChild(installBtn);
            }
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    dismissInstall();
                });
            }
        }

        function dismissInstall() {
            const installBtn = document.getElementById('installButton');
            if (installBtn) {
                installBtn.remove();
            }
        }

        // Handle app installed event
        window.addEventListener('appinstalled', (evt) => {
            console.log('App was installed');
            dismissInstall();
        });

        // Check if app is running in standalone mode (installed)
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
            document.body.classList.add('standalone');
        }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
