{% extends "base.html" %}

{% block title %}Notification Debug - meowCHAT{% endblock %}

{% block content %}
<div class="dashboard-content">
    <div class="dashboard-inner">
        <div class="card">
            <div class="card-header">
                <h3>Notification Debug Panel</h3>
                <p class="text-muted">Debug and test push notifications</p>
            </div>
            <div class="card-body">
                <!-- Notification Status -->
                <div class="mb-4">
                    <h5>Notification Status</h5>
                    <div id="notificationStatus" class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i> Checking status...
                    </div>
                </div>

                <!-- Browser Support -->
                <div class="mb-4">
                    <h5>Browser Support</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-secondary">
                                <strong>Service Worker:</strong> 
                                <span id="swSupport">Checking...</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-secondary">
                                <strong>Push Manager:</strong> 
                                <span id="pushSupport">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-secondary">
                                <strong>Notification Permission:</strong> 
                                <span id="notificationPermission">Checking...</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-secondary">
                                <strong>PWA Utils:</strong> 
                                <span id="pwaUtilsStatus">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mb-4">
                    <h5>Actions</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <button id="requestPermissionBtn" class="btn btn-primary mb-2">
                                <i class="fas fa-bell"></i> Request Permission
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="subscribeBtn" class="btn btn-success mb-2">
                                <i class="fas fa-plus"></i> Subscribe to Push
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <button id="testNotificationBtn" class="btn btn-warning mb-2">
                                <i class="fas fa-paper-plane"></i> Send Test Notification
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="unsubscribeBtn" class="btn btn-danger mb-2">
                                <i class="fas fa-times"></i> Unsubscribe
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="mb-4">
                    <h5>Debug Logs</h5>
                    <div id="debugLogs" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
                        <div>Debug logs will appear here...</div>
                    </div>
                    <button id="clearLogsBtn" class="btn btn-outline-secondary btn-sm mt-2">
                        Clear Logs
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Debug logging
function log(message, type = 'info') {
    const logs = document.getElementById('debugLogs');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
    logs.appendChild(logEntry);
    logs.scrollTop = logs.scrollHeight;
}

// Check browser support
function checkBrowserSupport() {
    const swSupport = document.getElementById('swSupport');
    const pushSupport = document.getElementById('pushSupport');
    const notificationPermission = document.getElementById('notificationPermission');
    const pwaUtilsStatus = document.getElementById('pwaUtilsStatus');

    // Service Worker support
    if ('serviceWorker' in navigator) {
        swSupport.innerHTML = '<span class="text-success">✓ Supported</span>';
        log('Service Worker: Supported', 'success');
    } else {
        swSupport.innerHTML = '<span class="text-danger">✗ Not Supported</span>';
        log('Service Worker: Not Supported', 'error');
    }

    // Push Manager support
    if ('PushManager' in window) {
        pushSupport.innerHTML = '<span class="text-success">✓ Supported</span>';
        log('Push Manager: Supported', 'success');
    } else {
        pushSupport.innerHTML = '<span class="text-danger">✗ Not Supported</span>';
        log('Push Manager: Not Supported', 'error');
    }

    // Notification permission
    if ('Notification' in window) {
        const permission = Notification.permission;
        if (permission === 'granted') {
            notificationPermission.innerHTML = '<span class="text-success">✓ Granted</span>';
            log('Notification Permission: Granted', 'success');
        } else if (permission === 'denied') {
            notificationPermission.innerHTML = '<span class="text-danger">✗ Denied</span>';
            log('Notification Permission: Denied', 'error');
        } else {
            notificationPermission.innerHTML = '<span class="text-warning">⚠ Default</span>';
            log('Notification Permission: Default (not requested)', 'warning');
        }
    } else {
        notificationPermission.innerHTML = '<span class="text-danger">✗ Not Supported</span>';
        log('Notification Permission: Not Supported', 'error');
    }

    // PWA Utils status
    if (window.pwaUtils) {
        pwaUtilsStatus.innerHTML = '<span class="text-success">✓ Loaded</span>';
        log('PWA Utils: Loaded', 'success');
    } else {
        pwaUtilsStatus.innerHTML = '<span class="text-danger">✗ Not Loaded</span>';
        log('PWA Utils: Not Loaded', 'error');
    }
}

// Check notification status from server
async function checkNotificationStatus() {
    try {
        const response = await fetch('/api/notifications/status');
        const data = await response.json();
        
        const statusDiv = document.getElementById('notificationStatus');
        
        if (response.ok) {
            let statusHtml = '<div class="row">';
            statusHtml += `<div class="col-md-6"><strong>Push Available:</strong> ${data.push_available ? '✓ Yes' : '✗ No'}</div>`;
            statusHtml += `<div class="col-md-6"><strong>VAPID Configured:</strong> ${data.vapid_configured ? '✓ Yes' : '✗ No'}</div>`;
            statusHtml += '</div>';
            statusHtml += `<div class="mt-2"><strong>User Subscriptions:</strong> ${data.user_subscriptions}</div>`;
            
            if (data.subscriptions.length > 0) {
                statusHtml += '<div class="mt-2"><strong>Subscription Details:</strong><ul class="mt-1">';
                data.subscriptions.forEach(sub => {
                    statusHtml += `<li>ID: ${sub.id} - ${sub.endpoint}</li>`;
                });
                statusHtml += '</ul></div>';
            }
            
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = statusHtml;
            
            log(`Server Status: Push Available: ${data.push_available}, VAPID: ${data.vapid_configured}, Subscriptions: ${data.user_subscriptions}`, 'success');
        } else {
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = `<strong>Error:</strong> ${data.error}`;
            log(`Server Error: ${data.error}`, 'error');
        }
    } catch (error) {
        const statusDiv = document.getElementById('notificationStatus');
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        log(`Network Error: ${error.message}`, 'error');
    }
}

// Request notification permission
async function requestPermission() {
    try {
        log('Requesting notification permission...', 'info');
        const permission = await Notification.requestPermission();
        log(`Permission result: ${permission}`, permission === 'granted' ? 'success' : 'warning');
        checkBrowserSupport();
    } catch (error) {
        log(`Permission request failed: ${error.message}`, 'error');
    }
}

// Subscribe to push notifications
async function subscribeToPush() {
    try {
        log('Subscribing to push notifications...', 'info');
        
        if (!window.pwaUtils) {
            log('PWA Utils not available', 'error');
            return;
        }
        
        const result = await window.pwaUtils.subscribeToNotifications();
        if (result) {
            log('Successfully subscribed to push notifications', 'success');
            checkNotificationStatus();
        } else {
            log('Failed to subscribe to push notifications', 'error');
        }
    } catch (error) {
        log(`Subscription failed: ${error.message}`, 'error');
    }
}

// Send test notification
async function sendTestNotification() {
    try {
        log('Sending test notification...', 'info');
        
        const response = await fetch('/api/notifications/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            log(`Test notification sent: ${data.message}`, 'success');
        } else {
            log(`Test notification failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Test notification error: ${error.message}`, 'error');
    }
}

// Unsubscribe from notifications
async function unsubscribeFromNotifications() {
    try {
        log('Unsubscribing from notifications...', 'info');
        
        if (!window.pwaUtils) {
            log('PWA Utils not available', 'error');
            return;
        }
        
        const result = await window.pwaUtils.unsubscribeFromNotifications();
        if (result) {
            log('Successfully unsubscribed from notifications', 'success');
            checkNotificationStatus();
        } else {
            log('Failed to unsubscribe from notifications', 'error');
        }
    } catch (error) {
        log(`Unsubscribe failed: ${error.message}`, 'error');
    }
}

// Clear logs
function clearLogs() {
    const logs = document.getElementById('debugLogs');
    logs.innerHTML = '<div>Debug logs cleared...</div>';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initial checks
    checkBrowserSupport();
    checkNotificationStatus();
    
    // Button event listeners
    document.getElementById('requestPermissionBtn').addEventListener('click', requestPermission);
    document.getElementById('subscribeBtn').addEventListener('click', subscribeToPush);
    document.getElementById('testNotificationBtn').addEventListener('click', sendTestNotification);
    document.getElementById('unsubscribeBtn').addEventListener('click', unsubscribeFromNotifications);
    document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
    
    log('Notification debug panel loaded', 'info');
});
</script>

<style>
.log-entry {
    margin-bottom: 4px;
    padding: 2px 0;
}

.log-success {
    color: #28a745;
}

.log-error {
    color: #dc3545;
}

.log-warning {
    color: #ffc107;
}

.log-info {
    color: #17a2b8;
}
</style>
{% endblock %}
