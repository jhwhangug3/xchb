<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.first_name or user.username }} - Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/fav.png') }}">
</head>
<body data-viewed-user-id="{{ user.id }}" data-account-location="{{ (profile.location or '') | e }}">
    <header class="pf-header">
        <div class="pf-topbar">
            <a href="{{ url_for('dashboard') }}" class="pf-back"><i class="fas fa-arrow-left"></i></a>
            <div class="flex-1"></div>
            <button class="pf-kebab" id="openProfileMenu" aria-label="More"><i class="fas fa-ellipsis"></i></button>
        </div>
        <div class="pf-header-main">
            <div class="pf-avatar-wrap">
                <div class="pf-avatar">
                    {% if user.profile_picture %}
                    <img src="{{ user.profile_picture }}" alt="">
                    {% else %}
                    <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                <span id="presenceDot" class="presence-dot offline" aria-label="presence"></span>
            </div>
            <div class="pf-meta">
                <div class="pf-name-line">
                    <h1 class="pf-name">{{ user.first_name or user.username }} {{ user.last_name or '' }}</h1>
                    <span class="pf-dot">•</span>
                    <button class="pf-friends-link" id="openFriendsSheetTop">{{ friends|length }} friends</button>
                </div>
                <div class="pf-username">@{{ user.username }}</div>
            </div>
        </div>
    </header>

    <main class="pf-main">
        {% if profile and profile.bio %}
        <section class="pf-bio-inline">
            <div class="pf-text" id="bioText" data-profile-url-template="{{ url_for('view_user_profile_by_username', username='__USERNAME__') }}">{{ profile.bio }}</div>
        </section>
        {% endif %}
        {% if links and links|length > 0 %}
        <section class="pf-link-inline">
            {% set first_link = links[0] %}
            <a href="{{ first_link.url }}" target="_blank" rel="noopener" class="pf-website">{{ first_link.title or first_link.url }}</a>
        </section>
        {% endif %}

        <section class="pf-actions-inline">
            {% if me and me.id == user.id %}
            <a class="btn btn-outline-light btn-sm pf-btn" href="{{ url_for('profile') }}"><i class="fas fa-user-edit me-2"></i>Edit Profile</a>
            {% endif %}
            <a class="btn btn-dark btn-sm pf-btn" href="{{ url_for('direct_chat', user_id=user.id) }}"><i class="fas fa-message me-2"></i>Message</a>
        </section>

        <!-- User Posts Section -->
        <section class="user-posts-section">
            <div class="posts-header">
                <h5 class="posts-title">Posts</h5>
                <span class="posts-count" id="postsCount">0 posts</span>
            </div>
            
            <div class="user-posts-container" id="userPostsContainer">
                <div class="loading-posts">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading posts...</span>
                </div>
            </div>
            
            <div class="load-more-container" id="userLoadMoreContainer" style="display: none;">
                <button class="load-more-btn" id="userLoadMoreBtn">
                    Load More Posts
                </button>
            </div>
        </section>

        <section class="pf-section pf-friends-inline d-none">
            <button class="btn btn-secondary btn-sm" id="openFriendsSheet"><i class="fas fa-user-friends me-2"></i>Friends {{ '(' ~ friends|length ~ ')' }}</button>
        </section>

        <div class="pf-bottom-sheet" id="friendsSheet" aria-hidden="true">
            <div class="pf-sheet-backdrop" id="friendsBackdrop"></div>
            <div class="pf-sheet">
                <div class="pf-sheet-handle"></div>
                <div class="pf-sheet-header">
                    <h6 class="m-0">Friends</h6>
                    <button class="btn btn-outline-light btn-sm" id="closeFriendsSheet">Close</button>
                </div>
                <div class="pf-sheet-body">
                    {% for f in friends %}
                    <a href="{{ url_for('view_user_profile_by_username', username=f.username) }}" class="pf-friend pf-friend-row">
                        {% if f.profile_picture %}
                        <img src="{{ f.profile_picture }}" alt="">
                        {% else %}
                        <i class="fas fa-user-circle"></i>
                        {% endif %}
                        <div class="pf-friend-meta">
                            <strong>{{ f.first_name or f.username }}</strong>
                            <small class="text-muted">@{{ f.username }}</small>
                        </div>
                        <i class="fas fa-chevron-right ms-auto text-muted"></i>
                    </a>
                    {% endfor %}
                    {% if not friends %}
                    <div class="text-muted small">No friends yet</div> 
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="pf-bottom-sheet" id="profileMenuSheet" aria-hidden="true">
            <div class="pf-sheet-backdrop" id="menuBackdrop"></div>
            <div class="pf-sheet">
                <div class="pf-sheet-handle"></div>
                <div class="pf-sheet-header">
                    <h6 class="m-0">Profile options</h6>
                    <button class="btn btn-outline-light btn-sm" id="closeProfileMenu">Close</button>
                </div>
                <div class="pf-sheet-body">
                    <div class="pf-menu-row"><i class="fas fa-clock me-2"></i><span id="menuLocalTime">Loading…</span></div>
                    <div class="pf-menu-row"><i class="fas fa-map-marker-alt me-2"></i><span id="menuLocation">Account based in —</span></div>
                    <hr class="my-2"/>
                    <button class="btn w-100 mb-2" id="copyProfileLink"><i class="fas fa-link me-2"></i>Copy profile link</button>
                    <button class="btn w-100" id="shareToFriend"><i class="fas fa-paper-plane me-2"></i>Share in chat…</button>
                </div>
            </div>
        </div>
        
    </main>

    <script>
        // Presence and precise location/time for viewed user
        const VIEWED_USER_ID = Number(document.body.getAttribute('data-viewed-user-id'));
        async function pollPresence() {
            try {
                const res = await fetch(`/api/presence/${VIEWED_USER_ID}`);
                const d = await res.json();
                const dot = document.getElementById('presenceDot');
                if (d.online) { dot && (dot.classList.add('online'), dot.classList.remove('offline')); }
                else { dot && (dot.classList.add('offline'), dot.classList.remove('online')); }
            } catch (e) {
                const dot = document.getElementById('presenceDot');
                dot && (dot.classList.add('offline'), dot.classList.remove('online'));
            }
        }
        function autolinkBio() {
            const el = document.getElementById('bioText');
            if (!el) return;
            const template = el.getAttribute('data-profile-url-template') || '/u/__USERNAME__';
            const escapeHtml = (t) => { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
            const raw = el.textContent || '';
            const escaped = escapeHtml(raw);
            const linked = escaped.replace(/(^|\s)@([a-zA-Z0-9_\.]{3,30})/g, (m, pre, uname) => {
                const href = template.replace('__USERNAME__', uname);
                return `${pre}<a class="pf-mention" href="${href}">@${uname}</a>`;
            }).replace(/\n/g, '<br>');
            el.innerHTML = linked;
        }
        async function loadPreciseLocation() {
            try {
                const res = await fetch(`/api/profile/location/${VIEWED_USER_ID}`);
                const data = await res.json();
                if (data.timezone) {
                    const tz = data.timezone;
                    function updateLocalTimeTz() {
                        try {
                            const dt = new Date();
                            const fmt = new Intl.DateTimeFormat([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true, timeZone: tz, timeZoneName: 'shortOffset' });
                            const parts = fmt.formatToParts(dt);
                            const timeString = parts.filter(p => p.type !== 'timeZoneName').map(p => p.value).join('').trim();
                            let offsetLabel = (parts.find(p => p.type === 'timeZoneName') || {}).value || '';
                            const m = offsetLabel.match(/GMT([+-]\d{1,2})(?::?\d{2})?/i);
                            const pretty = m ? `GMT${m[1]}` : offsetLabel || 'GMT+0';
                            const lt = document.getElementById('localTime');
                            if (lt) lt.textContent = `${timeString} (${pretty})`;
                            const mT = document.getElementById('menuLocalTime');
                            if (mT) mT.textContent = `${timeString} (${pretty})`;
                        } catch (e) {}
                    }
                    updateLocalTimeTz();
                    setInterval(updateLocalTimeTz, 1000);
                    // Privacy-friendly location display from timezone
                    try {
                        if (tz.includes('/')) {
                            const parts = tz.split('/');
                            const region = parts[0].replace('_', ' ');
                            const city = parts.slice(1).join('/').replace(/_/g, ' ');
                            document.getElementById('userLocation').textContent = `${city}, ${region}`;
                        } else {
                            document.getElementById('userLocation').textContent = tz;
                        }
                    } catch (e) {}
                } else {
                    document.getElementById('userLocation').textContent = 'Location unavailable';
                    // Fallback: show device local time so UI never hangs on "Loading..."
                    try {
                        const mT = document.getElementById('menuLocalTime');
                        if (mT) mT.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    } catch (_) {}
                }
            } catch (e) {
                document.getElementById('userLocation').textContent = 'Location unavailable';
                try {
                    const mT = document.getElementById('menuLocalTime');
                    if (mT) mT.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                } catch (_) {}
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            pollPresence();
            setInterval(pollPresence, 8000);
            loadPreciseLocation();
            autolinkBio();
            // Friends bottom sheet
            const openFriends = document.getElementById('openFriendsSheet') || document.getElementById('openFriendsSheetTop');
            const closeFriends = document.getElementById('closeFriendsSheet');
            const sheet = document.getElementById('friendsSheet');
            const backdrop = document.getElementById('friendsBackdrop');
            function openSheet(){ sheet && sheet.classList.add('show'); document.body.style.overflow='hidden'; }
            function closeSheet(){ sheet && sheet.classList.remove('show'); document.body.style.overflow=''; }
            openFriends && openFriends.addEventListener('click', openSheet);
            closeFriends && closeFriends.addEventListener('click', closeSheet);
            backdrop && backdrop.addEventListener('click', closeSheet);

            // Kebab options bottom sheet
            const openMenu = document.getElementById('openProfileMenu');
            const menuSheet = document.getElementById('profileMenuSheet');
            const closeMenu = document.getElementById('closeProfileMenu');
            const menuBackdrop = document.getElementById('menuBackdrop');
            function openMenuSheet(){ menuSheet && menuSheet.classList.add('show'); document.body.style.overflow='hidden'; }
            function closeMenuSheet(){ menuSheet && menuSheet.classList.remove('show'); document.body.style.overflow=''; }
            openMenu && openMenu.addEventListener('click', openMenuSheet);
            closeMenu && closeMenu.addEventListener('click', closeMenuSheet);
            menuBackdrop && menuBackdrop.addEventListener('click', closeMenuSheet);

            // menuLocalTime will be filled by loadPreciseLocation using the user's timezone
            const mL = document.getElementById('menuLocation');
            const ACCOUNT_LOCATION = document.body.getAttribute('data-account-location') || '';
            if (mL) {
                mL.textContent = ACCOUNT_LOCATION ? `Account based in ${ACCOUNT_LOCATION}` : 'Account location unavailable';
            }

            // Share actions
            const copyBtn = document.getElementById('copyProfileLink');
            const shareBtn = document.getElementById('shareToFriend');
            const profileUrl = window.location.origin + `{{ url_for('view_user_profile_by_username', username=user.username) }}`;
            copyBtn && copyBtn.addEventListener('click', async function(){
                try { await navigator.clipboard.writeText(profileUrl); alert('Profile link copied'); } catch (_) { alert(profileUrl); }
            });
            shareBtn && shareBtn.addEventListener('click', function(){
                closeMenuSheet();
                openSheet();
            });
        });
    </script>
    
    <script>
        // User Posts Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const userPostsContainer = document.getElementById('userPostsContainer');
            const userLoadMoreBtn = document.getElementById('userLoadMoreBtn');
            const userLoadMoreContainer = document.getElementById('userLoadMoreContainer');
            const postsCount = document.getElementById('postsCount');
            
            const viewedUserId = document.body.getAttribute('data-viewed-user-id');
            
            let currentPage = 1;
            let isLoading = false;
            let hasMore = true;
            let totalPosts = 0;
            
            // Load user posts on page load
            loadUserPosts();
            
            // Load more button
            userLoadMoreBtn.addEventListener('click', function() {
                if (!isLoading && hasMore) {
                    currentPage++;
                    loadUserPosts();
                }
            });
            
            async function loadUserPosts() {
                if (isLoading) return;
                
                isLoading = true;
                
                if (currentPage === 1) {
                    userPostsContainer.innerHTML = `
                        <div class="loading-posts">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Loading posts...</span>
                        </div>
                    `;
                }
                
                try {
                    const response = await fetch(`/api/posts?user_id=${viewedUserId}&page=${currentPage}&per_page=10`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        displayUserPosts(data.posts);
                        hasMore = data.has_next;
                        totalPosts = data.total;
                        
                        // Update posts count
                        postsCount.textContent = `${totalPosts} post${totalPosts !== 1 ? 's' : ''}`;
                        
                        if (hasMore) {
                            userLoadMoreContainer.style.display = 'block';
                        } else {
                            userLoadMoreContainer.style.display = 'none';
                        }
                    } else {
                        throw new Error(data.error || 'Failed to load posts');
                    }
                } catch (error) {
                    console.error('Error loading user posts:', error);
                    userPostsContainer.innerHTML = `
                        <div class="empty-posts">
                            <div class="empty-posts-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="empty-posts-text">Failed to load posts</div>
                            <div class="empty-posts-subtext">Please try refreshing the page</div>
                        </div>
                    `;
                } finally {
                    isLoading = false;
                }
            }
            
            function displayUserPosts(posts) {
                if (currentPage === 1) {
                    userPostsContainer.innerHTML = '';
                }
                
                if (posts.length === 0 && currentPage === 1) {
                    userPostsContainer.innerHTML = `
                        <div class="empty-posts">
                            <div class="empty-posts-icon">
                                <i class="fas fa-feather"></i>
                            </div>
                            <div class="empty-posts-text">No posts yet</div>
                            <div class="empty-posts-subtext">This user hasn't posted anything yet</div>
                        </div>
                    `;
                    return;
                }
                
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    userPostsContainer.appendChild(postElement);
                });
            }
            
            function createPostElement(post) {
                const postDiv = document.createElement('div');
                postDiv.className = 'post-item';
                
                const timestamp = formatTimestamp(post.created_at);
                const displayName = post.user.first_name || post.user.username;
                
                // Set initial button states
                const likeIcon = post.user_liked ? 'fas fa-heart' : 'far fa-heart';
                const likeClass = post.user_liked ? 'post-action-btn liked' : 'post-action-btn';
                const repostIcon = post.user_reposted ? 'fas fa-retweet' : 'fas fa-retweet';
                const repostClass = post.user_reposted ? 'post-action-btn retweeted' : 'post-action-btn';
                
                // Add three-dot menu if user can edit/delete the post
                const threeDotMenu = post.can_delete ? `
                    <div class="post-options">
                        <button class="post-action-btn options-btn" onclick="togglePostOptions(${post.id})" title="More options">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div class="post-options-menu" id="postOptions${post.id}">
                            <button class="option-item" onclick="editPost(${post.id})">
                                <i class="fas fa-edit"></i>
                                Edit Post
                            </button>
                            <button class="option-item delete-option" onclick="deletePost(${post.id}, this)">
                                <i class="fas fa-trash"></i>
                                Delete Post
                            </button>
                        </div>
                    </div>
                ` : '';
                
                postDiv.innerHTML = `
                    <div class="post-header">
                        <a href="/@${post.user.username}" class="post-user-avatar">
                            ${post.user.profile_picture ? 
                                `<img src="${post.user.profile_picture}" alt="${displayName}">` : 
                                `<i class="fas fa-user"></i>`
                            }
                        </a>
                        <div class="post-user-info">
                            <div class="post-user-name">
                                ${displayName}
                                <span class="post-username">@${post.user.username}</span>
                            </div>
                        </div>
                        <div class="post-timestamp">${timestamp}</div>
                    </div>
                    <div class="post-content">${escapeHtml(post.content)}</div>
                    <div class="post-actions">
                        <button class="${likeClass}" onclick="likePost(${post.id}, this)" title="Like" data-post-id="${post.id}">
                            <i class="${likeIcon}"></i>
                            <span class="like-count">${post.like_count}</span>
                        </button>
                        <button class="${repostClass}" onclick="retweetPost(${post.id}, this)" title="Repost" data-post-id="${post.id}">
                            <i class="${repostIcon}"></i>
                            <span class="repost-count">${post.repost_count}</span>
                        </button>
                        <button class="post-action-btn" onclick="replyToPost(${post.id})" title="Reply">
                            <i class="far fa-comment"></i>
                            <span class="comment-count">${post.comment_count}</span>
                        </button>
                        ${threeDotMenu}
                    </div>
                `;
                
                return postDiv;
            }
            
            function formatTimestamp(isoString) {
                // Parse the UTC timestamp and convert to local time
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'now';
                if (diffMins < 60) return `${diffMins}m`;
                if (diffHours < 24) return `${diffHours}h`;
                if (diffDays < 7) return `${diffDays}d`;
                
                return date.toLocaleDateString();
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        });
        
        // Post action functions
        async function likePost(postId, buttonElement) {
            try {
                const response = await fetch(`/api/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const icon = buttonElement.querySelector('i');
                    const countSpan = buttonElement.querySelector('.like-count');
                    
                    if (data.liked) {
                        // Like
                        icon.className = 'fas fa-heart';
                        buttonElement.classList.add('liked');
                    } else {
                        // Unlike
                        icon.className = 'far fa-heart';
                        buttonElement.classList.remove('liked');
                    }
                    
                    countSpan.textContent = data.like_count;
                } else {
                    console.error('Failed to like post:', data.error);
                }
            } catch (error) {
                console.error('Error liking post:', error);
            }
        }
        
        async function retweetPost(postId, buttonElement) {
            try {
                const response = await fetch(`/api/posts/${postId}/repost`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const icon = buttonElement.querySelector('i');
                    const countSpan = buttonElement.querySelector('.repost-count');
                    
                    if (data.reposted) {
                        // Repost
                        buttonElement.classList.add('retweeted');
                    } else {
                        // Unrepost
                        buttonElement.classList.remove('retweeted');
                    }
                    
                    countSpan.textContent = data.repost_count;
                } else {
                    console.error('Failed to repost:', data.error);
                }
            } catch (error) {
                console.error('Error reposting:', error);
            }
        }
        
        // Comments Modal Functionality
        let currentPostId = null;
        let currentPost = null;
        let commentsModal, commentsBackdrop, closeComments, originalPostDisplay, commentsList, commentInput, commentSubmitBtn;
        
        // Initialize modal elements when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            commentsModal = document.getElementById('commentsModal');
            commentsBackdrop = document.getElementById('commentsBackdrop');
            closeComments = document.getElementById('closeComments');
            originalPostDisplay = document.getElementById('originalPostDisplay');
            commentsList = document.getElementById('commentsList');
            commentInput = document.getElementById('commentInput');
            commentSubmitBtn = document.getElementById('commentSubmitBtn');
            
            // Close modal when clicking backdrop or close button
            commentsBackdrop.addEventListener('click', closeCommentsModal);
            closeComments.addEventListener('click', closeCommentsModal);
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && commentsModal.classList.contains('show')) {
                    closeCommentsModal();
                }
            });
            
            // Comment input functionality
            commentInput.addEventListener('input', function() {
                // Auto-resize
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                
                // Character count
                const length = this.value.length;
                const charCount = document.getElementById('charCount');
                if (charCount) {
                    charCount.textContent = `${length}/280`;
                }
                
                // Enable/disable button
                const text = this.value.trim();
                if (text.length > 0 && text.length <= 280) {
                    commentSubmitBtn.disabled = false;
                    commentSubmitBtn.classList.add('active');
                } else {
                    commentSubmitBtn.disabled = true;
                    commentSubmitBtn.classList.remove('active');
                }
            });
            
            commentInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!commentSubmitBtn.disabled) {
                        submitComment();
                    }
                }
            });
            
            commentSubmitBtn.addEventListener('click', submitComment);
        });
        
        function closeCommentsModal() {
            commentsModal.classList.remove('show');
            document.body.style.overflow = '';
            currentPostId = null;
            currentPost = null;
            commentInput.value = '';
            commentSubmitBtn.disabled = true;
            commentSubmitBtn.classList.remove('active');
        }
        
        function replyToPost(postId) {
            // Find the post element and open comments modal
            const postElement = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-item');
            openCommentsModal(postId, postElement);
        }
        
        function openCommentsModal(postId, postElement) {
            currentPostId = postId;
            currentPost = postElement;
            
            // Show original post in modal
            originalPostDisplay.innerHTML = postElement.outerHTML;
            
            // Show modal
            commentsModal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Load comments
            loadComments(postId);
            
            // Focus on comment input
            setTimeout(() => {
                commentInput.focus();
            }, 300);
        }
        
        async function loadComments(postId) {
            console.log('Loading comments for post:', postId);
            
            commentsList.innerHTML = `
                <div class="loading-comments">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading comments...</span>
                </div>
            `;
            
            try {
                console.log('Fetching from API...');
                const response = await fetch(`/api/posts/${postId}/comments`);
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Comments API Response:', { postId, response: data, status: response.status });
                
                if (response.ok && data.success) {
                    console.log('Displaying comments:', data.comments);
                    displayComments(data.comments || []);
                } else {
                    console.log('API returned error:', data.error);
                    throw new Error(data.error || 'Failed to load comments');
                }
            } catch (error) {
                console.error('Error loading comments:', error);
                commentsList.innerHTML = `
                    <div class="empty-comments">
                        <div class="empty-comments-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="empty-comments-text">Failed to load comments</div>
                        <div class="empty-comments-subtext">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function displayComments(comments) {
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="empty-comments">
                        <div class="empty-comments-icon">
                            <i class="fas fa-comment"></i>
                        </div>
                        <div class="empty-comments-text">No comments yet</div>
                        <div class="empty-comments-subtext">Be the first to comment!</div>
                    </div>
                `;
                return;
            }
            
            commentsList.innerHTML = comments.map(comment => createCommentElement(comment)).join('');
        }
        
        function createCommentElement(comment) {
            const timestamp = formatTimestamp(comment.created_at);
            const displayName = comment.user.first_name || comment.user.username;
            
            // Add three-dot menu if user can edit/delete the comment
            const threeDotMenu = comment.can_delete ? `
                <div class="comment-options">
                    <button class="comment-action-btn options-btn" onclick="toggleCommentOptions(${comment.id})" title="More options">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="comment-options-menu" id="commentOptions${comment.id}">
                        <button class="option-item" onclick="editComment(${comment.id})">
                            <i class="fas fa-edit"></i>
                            Edit Comment
                        </button>
                        <button class="option-item delete-option" onclick="deleteComment(${comment.id}, this)">
                            <i class="fas fa-trash"></i>
                            Delete Comment
                        </button>
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-avatar">
                        ${comment.user.profile_picture ? 
                            `<img src="${comment.user.profile_picture}" alt="${displayName}">` : 
                            `<i class="fas fa-user"></i>`
                        }
                    </div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">${displayName}</span>
                            <span class="comment-username">@${comment.user.username}</span>
                            <span class="comment-timestamp">${timestamp}</span>
                            ${threeDotMenu}
                        </div>
                        <div class="comment-text">${escapeHtml(comment.content)}</div>
                    </div>
                </div>
            `;
        }
        
        async function submitComment() {
            if (!currentPostId) return;
            
            const content = commentInput.value.trim();
            if (content.length === 0 || content.length > 280) return;
            
            // Disable button during submission
            commentSubmitBtn.disabled = true;
            commentSubmitBtn.textContent = 'Posting...';
            
            try {
                const response = await fetch(`/api/posts/${currentPostId}/comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: content })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Clear input and reset
                    commentInput.value = '';
                    commentInput.style.height = 'auto';
                    commentSubmitBtn.disabled = true;
                    commentSubmitBtn.classList.remove('active');
                    commentSubmitBtn.textContent = 'Post';
                    
                    // Reset character count
                    const charCount = document.getElementById('charCount');
                    if (charCount) {
                        charCount.textContent = '0/280';
                    }
                    
                    // Reload comments to show the new comment
                    loadComments(currentPostId);
                    
                    // Update comment count in the original post
                    if (currentPost) {
                        const commentCountSpan = currentPost.querySelector('.comment-count');
                        commentCountSpan.textContent = data.comment_count;
                    }
                } else {
                    console.error('Failed to add comment:', data.error);
                    alert('Failed to add comment: ' + data.error);
                    commentSubmitBtn.disabled = false;
                    commentSubmitBtn.textContent = 'Post';
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Failed to add comment');
                commentSubmitBtn.disabled = false;
                commentSubmitBtn.textContent = 'Post';
            }
        }
        
        // Toggle Post Options Menu
        function togglePostOptions(postId) {
            // Close all other open menus first
            const allMenus = document.querySelectorAll('.post-options-menu.show');
            allMenus.forEach(menu => {
                if (menu.id !== `postOptions${postId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle the clicked menu
            const menu = document.getElementById(`postOptions${postId}`);
            if (menu) {
                menu.classList.toggle('show');
            }
        }
        
        // Close all menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.post-options')) {
                const allMenus = document.querySelectorAll('.post-options-menu.show');
                allMenus.forEach(menu => menu.classList.remove('show'));
            }
        });
        
        // Edit Post Function
        function editPost(postId) {
            // Close the menu
            const menu = document.getElementById(`postOptions${postId}`);
            if (menu) {
                menu.classList.remove('show');
            }
            
            // For now, show a simple prompt (you can enhance this with a modal later)
            const postElement = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-item');
            const currentContent = postElement.querySelector('.post-content').textContent;
            
            const newContent = prompt('Edit your post:', currentContent);
            if (newContent && newContent.trim() && newContent !== currentContent) {
                updatePost(postId, newContent.trim());
            }
        }
        
        // Update Post Function
        async function updatePost(postId, newContent) {
            try {
                const response = await fetch(`/api/posts/${postId}/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: newContent })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Update the post content in the DOM
                    const postElement = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-item');
                    const contentElement = postElement.querySelector('.post-content');
                    contentElement.innerHTML = escapeHtml(newContent);
                    
                    // Show success message
                    alert('Post updated successfully!');
                } else {
                    console.error('Failed to update post:', data.error);
                    alert('Failed to update post: ' + data.error);
                }
            } catch (error) {
                console.error('Error updating post:', error);
                alert('Failed to update post');
            }
        }
        
        // Delete Post Function
        async function deletePost(postId, buttonElement) {
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/posts/${postId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Remove the post element from the DOM
                    const postElement = buttonElement.closest('.post-item');
                    postElement.remove();
                    
                    // Update posts count
                    const postsCount = document.getElementById('postsCount');
                    const currentCount = parseInt(postsCount.textContent.match(/\d+/)[0]);
                    postsCount.textContent = `${currentCount - 1} post${currentCount - 1 !== 1 ? 's' : ''}`;
                    
                    // Show success message
                    alert('Post deleted successfully!');
                } else {
                    console.error('Failed to delete post:', data.error);
                    alert('Failed to delete post: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('Failed to delete post');
            }
        }
        
        // Toggle Comment Options Menu
        function toggleCommentOptions(commentId) {
            // Close all other open menus first
            const allMenus = document.querySelectorAll('.comment-options-menu.show');
            allMenus.forEach(menu => {
                if (menu.id !== `commentOptions${commentId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle the clicked menu
            const menu = document.getElementById(`commentOptions${commentId}`);
            if (menu) {
                menu.classList.toggle('show');
            }
        }
        
        // Close all comment menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.comment-options')) {
                const allMenus = document.querySelectorAll('.comment-options-menu.show');
                allMenus.forEach(menu => menu.classList.remove('show'));
            }
        });
        
        // Edit Comment Function
        function editComment(commentId) {
            // Close the menu
            const menu = document.getElementById(`commentOptions${commentId}`);
            if (menu) {
                menu.classList.remove('show');
            }
            
            // Find the comment element and get current content
            const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
            const currentContent = commentElement.querySelector('.comment-text').textContent;
            
            const newContent = prompt('Edit your comment:', currentContent);
            if (newContent && newContent.trim() && newContent !== currentContent) {
                updateComment(commentId, newContent.trim());
            }
        }
        
        // Update Comment Function
        async function updateComment(commentId, newContent) {
            try {
                const response = await fetch(`/api/comments/${commentId}/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: newContent })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Update the comment content in the DOM
                    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                    const contentElement = commentElement.querySelector('.comment-text');
                    contentElement.innerHTML = escapeHtml(newContent);
                    
                    // Show success message
                    alert('Comment updated successfully!');
                } else {
                    console.error('Failed to update comment:', data.error);
                    alert('Failed to update comment: ' + data.error);
                }
            } catch (error) {
                console.error('Error updating comment:', error);
                alert('Failed to update comment');
            }
        }
        
        // Delete Comment Function
        async function deleteComment(commentId, buttonElement) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/comments/${commentId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Remove the comment element from the DOM
                    const commentElement = buttonElement.closest('.comment-item');
                    commentElement.remove();
                    
                    // Update comment count in the original post
                    if (currentPost) {
                        const commentCountSpan = currentPost.querySelector('.comment-count');
                        commentCountSpan.textContent = data.comment_count;
                    }
                    
                    // Show success message
                    alert('Comment deleted successfully!');
                } else {
                    console.error('Failed to delete comment:', data.error);
                    alert('Failed to delete comment: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Failed to delete comment');
            }
        }
    </script>
    
    <!-- Comments Modal -->
    <div class="comments-modal" id="commentsModal">
        <div class="comments-backdrop" id="commentsBackdrop"></div>
        <div class="comments-container">
            <div class="comments-header">
                <h5 class="comments-title">Comments</h5>
                <button class="close-comments" id="closeComments">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="comments-content">
                <div class="original-post" id="originalPostDisplay">
                    <!-- Original post content will be displayed here -->
                </div>
                
                <div class="comments-list" id="commentsList">
                    <div class="loading-comments">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading comments...</span>
                    </div>
                </div>
            </div>
            
            <div class="comment-input-section">
                <div class="comment-input-container">
                    <div class="comment-input-wrapper">
                        <textarea 
                            class="comment-input" 
                            id="commentInput" 
                            placeholder="Write a comment..."
                            maxlength="280"
                            rows="1"
                        ></textarea>
                        <button class="comment-submit-btn" id="commentSubmitBtn" disabled>
                            Post
                        </button>
                    </div>
                    <div class="comment-input-footer">
                        <span class="char-count" id="charCount">0/280</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bottom Navigation Bar - Only show when viewing own profile -->
    {% if me and me.id == user.id %}
    <nav class="bottom-nav" id="bottomNav">
        <div class="bottom-nav-inner">
            <a href="{{ url_for('dashboard') }}" class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                <i class="fas fa-home"></i>
            </a>
            <a href="{{ url_for('messaging') }}" class="nav-item {% if request.endpoint == 'messaging' %}active{% endif %}">
                <i class="fas fa-comment"></i>
            </a>
            <a href="{{ url_for('create_post') }}" class="nav-item {% if request.endpoint == 'create_post' %}active{% endif %}">
                <i class="fas fa-plus"></i>
            </a>
            <a href="{{ url_for('notifications') }}" class="nav-item {% if request.endpoint == 'notifications' %}active{% endif %}">
                <i class="fas fa-bell"></i>
            </a>
            <a href="{{ get_profile_url(user) }}" class="nav-item {% if request.endpoint in ['profile', 'view_user_profile_by_username', 'view_user_profile_by_username_alt', 'view_user_profile'] %}active{% endif %}">
                <div class="profile-avatar-small">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture }}" alt="Profile"/>
                    {% else %}
                        <i class="fas fa-user"></i>
                    {% endif %}
                </div>
            </a>
        </div>
    </nav>
    {% endif %}
</body>
</html>


